# FROST Signer Service - Docker Compose Configuration
#
# Runs a coordinator (port 5002) + 3 signers for local development.
# The coordinator orchestrates DKG and signing; signers hold key shares.
#
# All signers use the same internal port (5101) - differentiated by DNS name.
# Host ports (5101-5103) are for debugging from outside Docker only.
#
# Usage:
#   docker-compose -f docker-compose.signer.yml build
#   docker-compose -f docker-compose.signer.yml up
#
# Environment variables (optional):
#   INTERNAL_SERVICE_TOKEN - Shared secret for web app authentication
#   GUARDIAN_ASSERTION_JWKS_URL - JWKS endpoint for JWT verification (Phase 3)

services:
  signer-coordinator:
    build:
      context: ./apps/signer
      dockerfile: Dockerfile
      target: coordinator
    ports:
      - "5002:5002"
    environment:
      SIGNER_ROLE: coordinator
      SIGNER_PORT: 5002
      SIGNER_HOST: "::"  # IPv6 dual-stack (accepts both IPv4 and IPv6)
      SIGNER_DB_PATH: /var/lib/zentity/signer/coordinator.redb
      # All signers use the same port - differentiated by DNS name
      SIGNER_ENDPOINTS: http://signer-1:5101,http://signer-2:5101,http://signer-3:5101
      INTERNAL_SERVICE_TOKEN: ${INTERNAL_SERVICE_TOKEN:-dev-token}
      # mTLS not yet configured - will be added in Phase 2
      # SIGNER_MTLS_CA_PATH: /certs/ca.pem
      # SIGNER_MTLS_CERT_PATH: /certs/coordinator.pem
      # SIGNER_MTLS_KEY_PATH: /certs/coordinator.key
      GUARDIAN_ASSERTION_JWKS_URL: ${GUARDIAN_ASSERTION_JWKS_URL:-}
      RUST_LOG: signer_service=debug,actix_web=info
    volumes:
      - signer-coordinator-data:/var/lib/zentity/signer
      # Uncomment when mTLS certs are generated:
      # - ./certs/signer:/certs:ro
    depends_on:
      signer-1:
        condition: service_healthy
      signer-2:
        condition: service_healthy
      signer-3:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:5002/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - signer-net

  signer-1:
    build:
      context: ./apps/signer
      dockerfile: Dockerfile
      target: signer
    ports:
      - "5101:5101"  # Host 5101 → Container 5101
    environment:
      SIGNER_ROLE: signer
      SIGNER_ID: signer-1
      SIGNER_PORT: 5101
      SIGNER_HOST: "::"  # IPv6 dual-stack
      SIGNER_DB_PATH: /var/lib/zentity/signer/signer.redb
      SIGNER_CIPHERSUITE: secp256k1
      SIGNER_KEK_PROVIDER: ${SIGNER_KEK_PROVIDER:-local}
      SIGNER_KEK_ID: ${SIGNER_KEK_ID:-}
      RUST_LOG: signer_service=debug,actix_web=info
    volumes:
      - signer-1-data:/var/lib/zentity/signer
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:5101/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - signer-net

  signer-2:
    build:
      context: ./apps/signer
      dockerfile: Dockerfile
      target: signer
    ports:
      - "5102:5101"  # Host 5102 → Container 5101
    environment:
      SIGNER_ROLE: signer
      SIGNER_ID: signer-2
      SIGNER_PORT: 5101  # Same port as other signers
      SIGNER_HOST: "::"  # IPv6 dual-stack
      SIGNER_DB_PATH: /var/lib/zentity/signer/signer.redb
      SIGNER_CIPHERSUITE: secp256k1
      SIGNER_KEK_PROVIDER: ${SIGNER_KEK_PROVIDER:-local}
      SIGNER_KEK_ID: ${SIGNER_KEK_ID:-}
      RUST_LOG: signer_service=debug,actix_web=info
    volumes:
      - signer-2-data:/var/lib/zentity/signer
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:5101/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - signer-net

  signer-3:
    build:
      context: ./apps/signer
      dockerfile: Dockerfile
      target: signer
    ports:
      - "5103:5101"  # Host 5103 → Container 5101
    environment:
      SIGNER_ROLE: signer
      SIGNER_ID: signer-3
      SIGNER_PORT: 5101  # Same port as other signers
      SIGNER_HOST: "::"  # IPv6 dual-stack
      SIGNER_DB_PATH: /var/lib/zentity/signer/signer.redb
      SIGNER_CIPHERSUITE: secp256k1
      SIGNER_KEK_PROVIDER: ${SIGNER_KEK_PROVIDER:-local}
      SIGNER_KEK_ID: ${SIGNER_KEK_ID:-}
      RUST_LOG: signer_service=debug,actix_web=info
    volumes:
      - signer-3-data:/var/lib/zentity/signer
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:5101/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - signer-net

networks:
  signer-net:
    driver: bridge
    enable_ipv6: true

volumes:
  signer-coordinator-data:
  signer-1-data:
  signer-2-data:
  signer-3-data:
