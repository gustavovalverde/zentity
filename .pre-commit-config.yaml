# Pre-commit configuration for zentity monorepo
# See https://pre-commit.com for more information

# Stop at first failure to save time
fail_fast: true

# Auto-install both pre-commit and commit-msg hooks
default_install_hook_types: [pre-commit, commit-msg]

# Minimum version requirement
minimum_pre_commit_version: "3.0.0"

repos:
  # ===========================================
  # Security
  # ===========================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.30.0
    hooks:
      - id: gitleaks

  # ===========================================
  # General file hygiene
  # ===========================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        exclude: ^(apps/.*/dist/|dist/|.*\.patch$)
      - id: end-of-file-fixer
        exclude: ^(apps/.*/dist/|dist/)
      - id: check-yaml
        args: [--allow-multiple-documents]
        exclude: pnpm-lock\.yaml$
      - id: check-toml
      - id: check-json
        exclude: (^\.vscode/|tsconfig.*\.json$)  # JSONC files (VSCode, TypeScript)
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: check-case-conflict
      - id: detect-private-key
      - id: no-commit-to-branch
        args: [--branch, main, --branch, master]

  # ===========================================
  # TypeScript/JavaScript/JSON/CSS (apps/web + apps/landing)
  # ===========================================
  - repo: local
    hooks:
      - id: biome-check-web
        name: biome-check (web)
        entry: bash -c 'cd apps/web && pnpm run lint:fix'
        language: system
        files: ^apps/web/.*\.(ts|tsx|js|jsx|json|css)$
        pass_filenames: false
      - id: biome-check-landing
        name: biome-check (landing)
        entry: bash -c 'cd apps/landing && pnpm run lint:fix'
        language: system
        files: ^apps/landing/.*\.(ts|tsx|js|jsx|json|css)$
        pass_filenames: false

  # TypeScript type-checking (apps/web)
  - repo: local
    hooks:
      - id: tsc-check-web
        name: TypeScript type-check (web)
        entry: bash -c 'cd apps/web && pnpm run type-check'
        language: system
        files: ^apps/web/.*\.(ts|tsx)$
        pass_filenames: false
      - id: tsc-check-landing
        name: TypeScript type-check (landing)
        entry: bash -c 'cd apps/landing && pnpm run type-check'
        language: system
        files: ^apps/landing/.*\.(ts|tsx)$
        pass_filenames: false

  # ===========================================
  # Dead code detection (apps/web)
  # ===========================================
  - repo: local
    hooks:
      - id: knip-check-web
        name: Knip dead code check (web)
        entry: bash -c 'cd apps/web && pnpm run knip'
        language: system
        files: ^apps/web/.*\.(ts|tsx)$
        pass_filenames: false

  # ===========================================
  # Markdown (repo-wide)
  # ===========================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.47.0
    hooks:
      - id: markdownlint
        args: [--fix]
        exclude: node_modules/

  # ===========================================
  # Python (apps/ocr)
  # ===========================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.9
    hooks:
      - id: ruff-check
        args: [--fix]
        files: ^apps/ocr/
      - id: ruff-format
        files: ^apps/ocr/

  - repo: local
    hooks:
      - id: ocr-requirements-lock
        name: pip-compile lock (ocr)
        entry: bash scripts/check-ocr-requirements-lock.sh
        language: python
        additional_dependencies: [pip-tools]
        files: ^apps/ocr/(pyproject\.toml|requirements\.lock)$
        pass_filenames: false

  # ===========================================
  # Rust (apps/fhe)
  # ===========================================
  - repo: local
    hooks:
      - id: cargo-fmt-fhe
        name: cargo fmt (fhe)
        entry: cargo fmt --manifest-path apps/fhe/Cargo.toml --
        language: system
        files: ^apps/fhe/.*\.rs$
        pass_filenames: false
      - id: cargo-clippy-fhe
        name: cargo clippy (fhe)
        entry: cargo clippy --manifest-path apps/fhe/Cargo.toml -- -D warnings
        language: system
        files: ^apps/fhe/.*\.rs$
        pass_filenames: false

  # ===========================================
  # Rust (apps/signer)
  # ===========================================
  - repo: local
    hooks:
      - id: cargo-fmt-signer
        name: cargo fmt (signer)
        entry: cargo fmt --manifest-path apps/signer/Cargo.toml --
        language: system
        files: ^apps/signer/.*\.rs$
        pass_filenames: false
      - id: cargo-clippy-signer
        name: cargo clippy (signer)
        entry: cargo clippy --manifest-path apps/signer/Cargo.toml -- -D warnings
        language: system
        files: ^apps/signer/.*\.rs$
        pass_filenames: false

  # ===========================================
  # Commit message validation
  # ===========================================
  - repo: local
    hooks:
      - id: commitlint
        name: commitlint
        entry: bash -c 'cd apps/web && pnpm exec commitlint --edit "$0"'
        language: system
        stages: [commit-msg]
