# cargo-nextest configuration for FHE service
# See: https://nexte.st/docs/configuration/
#
# USAGE:
#   cargo nextest run -P dev          # Fast tests only (<1s) - USE THIS FOR DEVELOPMENT
#   cargo nextest run                 # All tests (~15-20 min) - Fast tests run FIRST
#   cargo nextest run -P ci           # CI mode with retries
#   cargo nextest run -E 'not test(roundtrip)'  # Custom filter
#
# IMPORTANT: TFHE key generation is EXTREMELY slow (~10-30s per test binary).
# Tests are consolidated into a single binary (http_fhe_test) to ensure keys
# are generated only ONCE and reused across all tests.

[store]
dir = "target/nextest"

# =============================================================================
# Test Groups
# =============================================================================

[test-groups]
# Tests that require TFHE key generation - limit concurrency heavily
fhe-heavy = { max-threads = 2 }

# Lightweight tests (no FHE keys needed)
lightweight = { max-threads = 8 }

# =============================================================================
# Dev Profile (fast feedback - RECOMMENDED FOR DEVELOPMENT)
# =============================================================================
# Skips all slow FHE encryption tests, runs only fast unit and HTTP tests.
# Use: cargo nextest run -P dev

[profile.dev]
slow-timeout = { period = "30s", terminate-after = 1 }
failure-output = "immediate"
success-output = "never"

# EXCLUDE slow tests entirely (not run, not timed out)
default-filter = '''
  not (
    test(roundtrip)
    | test(encrypt_and_verify)
    | test(verify_age)
    | test(encrypt_compliance_level_rejects_out_of_range)
    | test(encrypt_country_code_rejects_out_of_range)
    | binary(http_fhe_test)
    | binary(persistence_test)
  )
'''

# =============================================================================
# Default Profile (full test suite)
# =============================================================================

[profile.default]
# Long default timeout - TFHE operations are slow
slow-timeout = { period = "120s", terminate-after = 3 }

# Show output for failing tests immediately
failure-output = "immediate"

# Don't show output for passing tests
success-output = "never"

retries = 0

# =============================================================================
# Per-Test Overrides (default profile)
# =============================================================================

# PRIORITY: Fast tests run FIRST (priority > 0)
# Gives quick feedback before slow FHE tests start

[[profile.default.overrides]]
filter = 'binary(http_health_test) | binary(http_auth_test)'
slow-timeout = { period = "30s" }
test-group = 'lightweight'
priority = 50

# Fast unit tests (no FHE operations)
[[profile.default.overrides]]
filter = '''
  test(date_to_days)
  | test(test_scale_factor)
  | test(test_rounding)
  | test(test_precision)
  | test(test_error_messages)
  | test(test_score_to_u16)
  | test(test_threshold_to_u16)
  | test(test_u16_to_score)
  | test(test_score_roundtrip)
'''
priority = 50

# PRIORITY: Slow FHE tests run LAST (priority < 0)

# Unit tests with FHE roundtrips - run last
[[profile.default.overrides]]
filter = 'test(roundtrip) | test(encrypt_and_verify) | test(verify_age)'
slow-timeout = { period = "180s", terminate-after = 2 }
threads-required = 2
test-group = 'fhe-heavy'
priority = -50

# Consolidated HTTP FHE tests - run last
[[profile.default.overrides]]
filter = '''
  package(fhe-service)
  & (binary(http_fhe_test)
     | binary(persistence_test))
'''
slow-timeout = { period = "300s", terminate-after = 2 }
threads-required = 2
test-group = 'fhe-heavy'
priority = -50

# =============================================================================
# CI Profile (full suite with retries)
# =============================================================================

[profile.ci]
fail-fast = false
slow-timeout = { period = "300s", terminate-after = 3 }
retries = 1
failure-output = "immediate-final"
success-output = "final"

[[profile.ci.overrides]]
filter = '''
  package(fhe-service)
  & (binary(http_fhe_test)
     | binary(persistence_test))
'''
slow-timeout = { period = "600s", terminate-after = 2 }
retries = 2
priority = -50

[[profile.ci.overrides]]
filter = 'test(roundtrip) | test(encrypt_and_verify) | test(verify_age)'
slow-timeout = { period = "600s", terminate-after = 2 }
retries = 2
priority = -50
