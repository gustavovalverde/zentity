name: Code Quality

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RUST_TOOLCHAIN: "1.92.0"

jobs:
  # ============================================
  # Pre-commit (runs all hooks with caching)
  # ============================================
  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "24"
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.19.0
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy
      - name: Install pnpm dependencies (web)
        run: pnpm install --frozen-lockfile
        working-directory: apps/web
      - name: Install pnpm dependencies (landing)
        run: pnpm install --frozen-lockfile
        working-directory: apps/landing
      - uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-
      - uses: pre-commit/action@2c7b3805fd2a0fd8c1884dcaebf91fc102a13ecd # v3.0.1
        env:
          # Skip no-commit-to-branch hook in CI - it's meant for local dev only
          SKIP: no-commit-to-branch

  # ============================================
  # TypeScript / JavaScript (apps/web)
  # ============================================
  typescript-web:
    name: TypeScript - Web (Biome + tsc)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "24"
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.19.0
      - run: pnpm install --frozen-lockfile
        working-directory: apps/web
      - run: pnpm run lint:check
        working-directory: apps/web
      - run: pnpm run type-check
        working-directory: apps/web

  # ============================================
  # TypeScript / JavaScript (apps/landing)
  # ============================================
  typescript-landing:
    name: TypeScript - Landing (Biome + tsc)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "24"
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.19.0
      - run: pnpm install --frozen-lockfile
        working-directory: apps/landing
      - run: pnpm run lint:check
        working-directory: apps/landing
      - run: pnpm run type-check
        working-directory: apps/landing

  js-security:
    name: JavaScript (Security Audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "24"
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.19.0
      - run: pnpm install --frozen-lockfile
        working-directory: apps/web
      - name: Run security audit
        run: pnpm audit --audit-level moderate || echo "Some vulnerabilities found - review required"
        working-directory: apps/web

  markdown:
    name: Markdown (markdownlint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "24"
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.19.0
      - run: pnpm install --frozen-lockfile
        working-directory: apps/web
      - name: Run markdownlint (repo-wide)
        run: pnpm exec markdownlint "../../**/*.md" --config ../../.markdownlint.json --ignore "**/node_modules/**" --ignore "**/venv/**" --ignore "../../docs/archive/**" --ignore "../../docs/internal/**"
        working-directory: apps/web

  # ============================================
  # Python
  # ============================================
  python:
    name: Python (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
      - run: pip install ruff
      - run: ruff check apps/ocr
      - run: ruff format --check apps/ocr

  python-security:
    name: Python (Security Audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
      - name: Install dependencies and security tools
        run: |
          pip install pip-audit bandit
          pip install -e apps/ocr
      - name: Run pip-audit (dependency vulnerabilities)
        run: pip-audit
        continue-on-error: true
      - name: Run bandit (code security)
        run: bandit -r apps/ocr/app -ll -ii
        continue-on-error: true

  # ============================================
  # Rust
  # ============================================
  rust:
    name: Rust (fmt + clippy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy
      # FHE service
      - run: cargo fmt --manifest-path apps/fhe/Cargo.toml -- --check
      - run: cargo clippy --manifest-path apps/fhe/Cargo.toml -- -D warnings
      # Signer service
      - run: cargo fmt --manifest-path apps/signer/Cargo.toml -- --check
      - run: cargo clippy --manifest-path apps/signer/Cargo.toml -- -D warnings

  rust-security:
    name: Rust (Security Audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      # Set up Rust toolchain with caching
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      # cargo-deny for banned crates and source restrictions
      - uses: EmbarkStudios/cargo-deny-action@3fd3802e88374d3fe9159b834c7714ec57d6c979 # v2.0.15
        with:
          manifest-path: apps/fhe/Cargo.toml
          command: check bans sources
      # cargo-audit for CVE scanning
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Run cargo-audit (FHE service)
        run: cargo audit --file apps/fhe/Cargo.lock
        continue-on-error: true
      - name: Run cargo-audit (Signer service)
        run: cargo audit --file apps/signer/Cargo.lock
        continue-on-error: true

  # ============================================
  # Commit & PR Quality
  # ============================================
  commitlint:
    name: Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: wagoid/commitlint-github-action@b948419dd99f3fd78a6548d48f94e3df7f6bf3ed # v6.2.1
