name: Code Quality

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ============================================
  # Pre-commit (runs all hooks with caching)
  # ============================================
  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          components: rustfmt, clippy
      - name: Install bun dependencies (web)
        run: bun install --frozen-lockfile
        working-directory: apps/web
      - name: Install bun dependencies (landing)
        run: bun install --frozen-lockfile
        working-directory: apps/landing
      - uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf # v4.2.2
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-
      - uses: pre-commit/action@2c7b3805fd2a0fd8c1884dcaebf91fc102a13ecd # v3.0.1
        env:
          # Skip no-commit-to-branch hook in CI - it's meant for local dev only
          SKIP: no-commit-to-branch

  # ============================================
  # TypeScript / JavaScript (apps/web)
  # ============================================
  typescript-web:
    name: TypeScript - Web (Biome + tsc)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
      - run: bun install --frozen-lockfile
        working-directory: apps/web
      - run: bun run lint:check
        working-directory: apps/web
      - run: bun run type-check
        working-directory: apps/web

  # ============================================
  # TypeScript / JavaScript (apps/landing)
  # ============================================
  typescript-landing:
    name: TypeScript - Landing (Biome + tsc)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
      - run: bun install --frozen-lockfile
        working-directory: apps/landing
      - run: bun run lint:check
        working-directory: apps/landing
      - run: bun run type-check
        working-directory: apps/landing

  js-security:
    name: JavaScript (Security Audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
      - run: bun install --frozen-lockfile
        working-directory: apps/web
      - name: Run security audit
        run: bun audit --level moderate || true
        working-directory: apps/web
        # Note: bun audit may not be fully implemented yet
        # Fallback to npm audit if needed
      - name: Fallback npm audit
        run: npm audit --audit-level=moderate || echo "Some vulnerabilities found - review required"
        working-directory: apps/web

  markdown:
    name: Markdown (markdownlint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
      - run: bun install --frozen-lockfile
        working-directory: apps/web
      - name: Run markdownlint (repo-wide)
        run: bunx markdownlint-cli "**/*.md" --ignore "**/node_modules/**" --ignore "**/venv/**" --ignore "docs/archive/**"

  # ============================================
  # Python
  # ============================================
  python:
    name: Python (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
      - run: pip install ruff
      - run: ruff check apps/ocr
      - run: ruff format --check apps/ocr

  python-security:
    name: Python (Security Audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
      - name: Install dependencies and security tools
        run: |
          pip install pip-audit bandit
          pip install -e apps/ocr
      - name: Run pip-audit (dependency vulnerabilities)
        run: pip-audit
        continue-on-error: true
      - name: Run bandit (code security)
        run: bandit -r apps/ocr/app -ll -ii
        continue-on-error: true

  # ============================================
  # Rust
  # ============================================
  rust:
    name: Rust (fmt + clippy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          components: rustfmt, clippy
      - run: cargo fmt --manifest-path apps/fhe/Cargo.toml -- --check
      - run: cargo clippy --manifest-path apps/fhe/Cargo.toml -- -D warnings

  rust-security:
    name: Rust (Security Audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
      # cargo-deny for banned crates and source restrictions
      - uses: EmbarkStudios/cargo-deny-action@e2f4ede4a4e60ea15ff31bc0647485d80c66cfba # v2.0.4
        with:
          manifest-path: apps/fhe/Cargo.toml
          command: check bans sources
      # cargo-audit for CVE scanning
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run cargo-audit
        run: cargo audit --file apps/fhe/Cargo.lock
        continue-on-error: true

  # ============================================
  # Commit & PR Quality
  # ============================================
  commitlint:
    name: Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: wagoid/commitlint-github-action@b948419dd99f3fd78a6548d48f94e3df7f6bf3ed # v6.2.1
